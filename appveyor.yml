# source: https://github.com/starkat99/appveyor-rust/blob/master/appveyor.yml
# source: https://github.com/japaric/rust-everywhere/blob/master/appveyor.yml

version: 0.1.0-build{build}

matrix:
  fast_finish: true

environment:
  PROJECT_NAME: terraform-zap
  global:
  - BINARY_NAME=auto-release
  - REPO_USERNAME=guangie88
  - REPO_NAME=auto-release-rs
  matrix:
  # Stable channel
  # - TARGET: i686-pc-windows-gnu
  #   CHANNEL: stable
  - TARGET: i686-pc-windows-msvc
    CHANNEL: stable
    ARTIFACT: true
  # - TARGET: x86_64-pc-windows-gnu
  #   CHANNEL: stable
  - TARGET: x86_64-pc-windows-msvc
    CHANNEL: stable
    ARTIFACT: true

  # Beta channel
  # - TARGET: i686-pc-windows-gnu
  #   CHANNEL: beta
  # - TARGET: i686-pc-windows-msvc
  #   CHANNEL: beta
  # - TARGET: x86_64-pc-windows-gnu
  #   CHANNEL: beta
  # - TARGET: x86_64-pc-windows-msvc
  #   CHANNEL: beta
    
  # Nightly channel
  # - TARGET: i686-pc-windows-gnu
  #   CHANNEL: nightly
  # - TARGET: i686-pc-windows-msvc
  #   CHANNEL: nightly
  # - TARGET: x86_64-pc-windows-gnu
  #   CHANNEL: nightly
  # - TARGET: x86_64-pc-windows-msvc
  #   CHANNEL: nightly

install:
- curl -sSf -o rustup-init.exe https://win.rustup.rs
- rustup-init.exe --default-host %TARGET% --default-toolchain %CHANNEL% -y
- set PATH=%PATH%;C:\Users\appveyor\.cargo\bin
- rustc -vV
- cargo -vV
- if "%TARGET%"=="i686-pc-windows-gnu"
    cinst mingw --x86 -y &
    set "PATH=%PATH%;C:\tools\mingw32\bin" &
    gcc --version
- if "%TARGET%"=="x86_64-pc-windows-gnu"
    cinst mingw -y &
    set "PATH=%PATH%;C:\tools\mingw64\bin" &
    gcc --version
- echo %PATH%

# `cargo test` suffices for non-artifact builds.
test_script:
- cargo build --verbose
- cargo test --all

build_script:
# - if %ARTIFACT%=="true" if "%APPVEYOR_REPO_TAG%"=="true"
#     cargo build --release --verbose
- if %ARTIFACT%=="true"
    cargo build --release --verbose

deploy:
  provider: GitHub
  auth_token:
    secure: "njCwSow8gtsplARSx0TLiQRB29GHALM67ClkPuE6Z8JbTR6A3k4UKDcUuJE4WK9C"
  artifact: /Foo-.*\.tar.gz/
  draft: false
  prerelease: false
  on:
    appveyor_repo_tag: true

branches:
  only:
  - master
  - /^v\d+\.\d+\.\d+(-\S*)?$/
